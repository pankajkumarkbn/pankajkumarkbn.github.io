<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal Financial Planner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --card:#111827;        /* gray-900 */
      --muted:#94a3b8;       /* slate-400 */
      --text:#e5e7eb;        /* gray-200 */
      --accent:#22d3ee;      /* cyan-400 */
      --danger:#ef4444;      /* red-500 */
      --ok:#22c55e;          /* green-500 */
      --warning:#f59e0b;     /* amber-500 */
      --border:#1f2937;      /* gray-800 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(120deg, #0b1226, #0a152e 60%, #0b1226);
      color:var(--text);
    }
    .container{max-width:1200px; margin:0 auto; padding:24px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:20px}
    .title{font-size:24px; font-weight:700; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
    .badge{padding:4px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}

    .toolbar{display:grid; grid-template-columns: repeat(12, minmax(0,1fr)); gap:12px; margin-bottom:18px}
    .card{background:rgba(17,24,39,.7); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:0 8px 30px rgba(0,0,0,.25); backdrop-filter: blur(6px)}
    select,input,button{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0b1226; color:var(--text)}
    input[type="number"]{text-align:right}
    button{cursor:pointer; transition:transform .06s ease, background .2s ease}
    button:hover{transform:translateY(-1px)}
    .btn-accent{background:linear-gradient(120deg, #0891b2, #22d3ee); color:#06121a; border:none; font-weight:700}
    .btn-ghost{background:transparent; border:1px dashed var(--border); color:var(--muted)}

    .tabs{display:flex; gap:6px; margin:14px 0}
    .tab{padding:10px 14px; border:1px solid var(--border); border-radius:999px; color:var(--muted); cursor:pointer}
    .tab.active{background:linear-gradient(120deg,#111827,#0b1226); color:var(--text); border-color:#1f2a44}

    .grid{display:grid; grid-template-columns:2fr 1fr; gap:16px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    table{width:100%; border-collapse:separate; border-spacing:0; font-size:14px}
    thead th{position:sticky; top:0; background:#0c152b; z-index:1}
    th,td{padding:10px 12px; border-bottom:1px solid var(--border)}
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover td{background:rgba(2,6,23,.35)}
    .type-pill{font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .pill-income{color:#0ea5e9; border-color:#0ea5e9}
    .pill-expense{color:#f59e0b; border-color:#f59e0b}
    .pill-saving{color:#22c55e; border-color:#22c55e}

    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-top:10px}
    .kpi{padding:14px; border-radius:16px; border:1px solid var(--border); background:linear-gradient(180deg,#0a152e,#0b1226)}
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{font-size:20px; font-weight:700; margin-top:6px}
    .kpi.negative{outline:1px solid rgba(239,68,68,.35)}

    .danger{color:var(--danger)}
    .ok{color:var(--ok)}

    .section-title{font-weight:700; margin-bottom:8px}
    .list{display:flex; flex-direction:column; gap:8px}

    .footer{margin-top:24px; color:var(--muted); font-size:12px; text-align:center}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">üí† Personal Financial Planner <span class="badge">v1.0</span></div>
      <div style="display:flex; gap:8px; align-items:center">
        <button id="exportExcel" class="btn-accent">Export to Excel</button>
        <button id="exportCSV" class="btn-ghost">Export CSV</button>
      </div>
    </header>

    <div class="toolbar">
      <div class="card" style="grid-column: span 4">
        <label>Month
          <select id="monthSelect"></select>
        </label>
      </div>
      <div class="card" style="grid-column: span 3">
        <label>Year
          <select id="yearSelect"></select>
        </label>
      </div>
      <div class="card" style="grid-column: span 3">
        <label>Savings Goal (% of Income)
          <input id="goalPercent" type="number" min="0" max="100" step="1" value="20" />
        </label>
      </div>
      <div class="card" style="grid-column: span 2; display:flex; gap:8px">
        <button id="saveMonth" class="btn-accent">Save</button>
        <button id="resetMonth" class="btn-ghost">Reset</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="monthly">Monthly Planner</button>
      <button class="tab" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="yearly">Yearly Overview</button>
    </div>

    <!-- MONTHLY VIEW -->
    <section id="monthly" class="card">
      <div class="grid">
        <div>
          <div class="section-title">Plan your month</div>
          <div style="overflow:auto; max-height:520px">
            <table id="budgetTable" aria-label="Monthly budget">
              <thead>
                <tr>
                  <th style="width:42%">Category</th>
                  <th style="width:14%">Type</th>
                  <th style="width:16%">Planned</th>
                  <th style="width:16%">Actual</th>
                  <th style="width:12%">Œî (Actual - Planned)</th>
                  <th class="sr-only">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="6" style="padding-top:12px">
                    <button id="addRow" class="btn-ghost" style="width:auto">Ôºã Add Category</button>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div>
          <div class="section-title">Insights</div>
          <div class="kpis">
            <div class="kpi" id="kpiIncome"><div class="label">Total Income</div><div class="value" id="totalIncome">‚Çπ0</div></div>
            <div class="kpi" id="kpiExpenses"><div class="label">Total Expenses</div><div class="value" id="totalExpenses">‚Çπ0</div></div>
            <div class="kpi" id="kpiSavings"><div class="label">Net Savings</div><div class="value" id="netSavings">‚Çπ0</div></div>
            <div class="kpi" id="kpiGoal"><div class="label">Goal vs Actual</div><div class="value" id="goalStatus">0% of 20%</div></div>
          </div>
          <div class="card" style="margin-top:12px">
            <canvas id="expensePie" height="220"></canvas>
          </div>
          <div class="card" style="margin-top:12px">
            <div class="section-title">Top 3 Expense Categories</div>
            <div id="top3" class="list"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD VIEW -->
    <section id="dashboard" class="card" style="display:none">
      <div class="section-title">Quick Summary</div>
      <div class="kpis">
        <div class="kpi"><div class="label">Savings Rate (Actual)</div><div class="value" id="dashSavingsRate">0%</div></div>
        <div class="kpi"><div class="label">Overspending (Actual vs Planned)</div><div class="value danger" id="dashOverspend">‚Çπ0</div></div>
        <div class="kpi"><div class="label">Emergency Fund (x monthly exp)</div><div class="value" id="dashEmergency">0x</div></div>
        <div class="kpi"><div class="label">Recurring Investments</div><div class="value" id="dashRecurring">‚Çπ0</div></div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div class="card">
          <div class="section-title">Income vs Expenses vs Savings (This Month)</div>
          <canvas id="iesBar" height="260"></canvas>
        </div>
        <div class="card">
          <div class="section-title">Notes</div>
          <textarea id="notes" placeholder="Your reminders / adjustments" style="width:100%; min-height:260px; border-radius:12px; border:1px solid var(--border); background:#0b1226; color:var(--text); padding:12px"></textarea>
        </div>
      </div>
    </section>

    <!-- YEARLY VIEW -->
    <section id="yearly" class="card" style="display:none">
      <div class="grid">
        <div>
          <div class="section-title">Yearly Table</div>
          <div style="overflow:auto; max-height:520px">
            <table id="yearlyTable">
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Income</th>
                  <th>Expenses</th>
                  <th>Savings</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th>Total</th>
                  <th id="yIncome">‚Çπ0</th>
                  <th id="yExpenses">‚Çπ0</th>
                  <th id="ySavings">‚Çπ0</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div>
          <div class="section-title">Yearly Trend</div>
          <div class="card"><canvas id="yearlyLine" height="280"></canvas></div>
        </div>
      </div>
    </section>

    <div class="footer">Made for you with ‚ù§Ô∏è by Pankaj ‚Ä¢ Works fully offline in your browser ‚Ä¢ Data saved to localStorage</div>
  </div>

<script>
(function(){
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const defaultCategories = [
    {name:"Income - Salary", type:"income"},
    {name:"Income - Other", type:"income"},
    {name:"Housing (Rent/EMI)", type:"expense"},
    {name:"Utilities", type:"expense"},
    {name:"Food & Groceries", type:"expense"},
    {name:"Transport", type:"expense"},
    {name:"Healthcare", type:"expense"},
    {name:"Entertainment", type:"expense"},
    {name:"Shopping", type:"expense"},
    {name:"Miscellaneous", type:"expense"},
    {name:"Savings & Investments", type:"saving"}
  ];

  const els = {
    monthSelect: document.getElementById('monthSelect'),
    yearSelect: document.getElementById('yearSelect'),
    goalPercent: document.getElementById('goalPercent'),
    saveMonth: document.getElementById('saveMonth'),
    resetMonth: document.getElementById('resetMonth'),
    addRow: document.getElementById('addRow'),
    tableBody: document.querySelector('#budgetTable tbody'),
    totalIncome: document.getElementById('totalIncome'),
    totalExpenses: document.getElementById('totalExpenses'),
    netSavings: document.getElementById('netSavings'),
    goalStatus: document.getElementById('goalStatus'),
    top3: document.getElementById('top3'),
    expensePie: document.getElementById('expensePie'),
    iesBar: document.getElementById('iesBar'),
    notes: document.getElementById('notes'),
    exportExcel: document.getElementById('exportExcel'),
    exportCSV: document.getElementById('exportCSV'),
    tabs: document.querySelectorAll('.tab'),
    monthly: document.getElementById('monthly'),
    dashboard: document.getElementById('dashboard'),
    yearly: document.getElementById('yearly'),
    yearlyTableBody: document.querySelector('#yearlyTable tbody'),
    yIncome: document.getElementById('yIncome'),
    yExpenses: document.getElementById('yExpenses'),
    ySavings: document.getElementById('ySavings'),
    yearlyLine: document.getElementById('yearlyLine'),
    dashSavingsRate: document.getElementById('dashSavingsRate'),
    dashOverspend: document.getElementById('dashOverspend'),
    dashEmergency: document.getElementById('dashEmergency'),
    dashRecurring: document.getElementById('dashRecurring'),
  };

  // init selects
  months.forEach((m,i)=>{
    const opt=document.createElement('option'); opt.value=i; opt.textContent=m; els.monthSelect.appendChild(opt);
  });
  const yNow = new Date().getFullYear();
  for(let y=yNow-3; y<=yNow+1; y++){ const opt=document.createElement('option'); opt.value=y; opt.textContent=y; els.yearSelect.appendChild(opt); }
  els.monthSelect.value = new Date().getMonth();
  els.yearSelect.value = yNow;

  // Tabs
  els.tabs.forEach(t=> t.addEventListener('click',()=>{
    els.tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
    els.monthly.style.display = t.dataset.tab==='monthly'? 'block':'none';
    els.dashboard.style.display = t.dataset.tab==='dashboard'? 'block':'none';
    els.yearly.style.display = t.dataset.tab==='yearly'? 'block':'none';
    if(t.dataset.tab==='yearly') buildYearly();
    if(t.dataset.tab==='dashboard') updateChartsAndKpis();
  }));

  // Data model helpers
  function key(){return `pfp:${els.yearSelect.value}-${String(Number(els.monthSelect.value)+1).padStart(2,'0')}`}
  function load(){
    const raw = localStorage.getItem(key());
    if(!raw) return { rows: JSON.parse(JSON.stringify(defaultCategories)).map(c=>({...c, planned:0, actual:0})), goalPct: Number(els.goalPercent.value)||20, notes:"" };
    const data = JSON.parse(raw);
    return data;
  }
  function save(){
    const rows = Array.from(els.tableBody.querySelectorAll('tr')).map(tr=>({
      name: tr.querySelector('.cat').value.trim()||'Untitled',
      type: tr.querySelector('.type').value,
      planned: Number(tr.querySelector('.planned').value)||0,
      actual: Number(tr.querySelector('.actual').value)||0,
    }));
    const data = { rows, goalPct: Number(els.goalPercent.value)||0, notes: els.notes.value||"" };
    localStorage.setItem(key(), JSON.stringify(data));
    toast('Saved');
    buildYearly();
  }

  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg; t.style.position='fixed'; t.style.bottom='18px'; t.style.right='18px'; t.style.padding='10px 14px'; t.style.background='rgba(34,211,238,.15)'; t.style.border='1px solid #164e63'; t.style.borderRadius='12px'; t.style.color:'#a5f3fc'; t.style.backdropFilter='blur(4px)';
    document.body.appendChild(t); setTimeout(()=>t.remove(), 1200);
  }

  function currency(n){ return '‚Çπ'+ (Number(n)||0).toLocaleString('en-IN'); }

  function buildTable(){
    els.tableBody.innerHTML='';
    const data = load();
    els.goalPercent.value = data.goalPct || 20;
    els.notes.value = data.notes || '';

    data.rows.forEach(addRow);
    recalc();
  }

  function addRow(row){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input class="cat" value="${row?.name||''}" placeholder="Category name" /></td>
      <td>
        <select class="type">
          <option value="income">Income</option>
          <option value="expense">Expense</option>
          <option value="saving">Saving</option>
        </select>
      </td>
      <td><input class="planned" type="number" min="0" step="1" value="${row?.planned||0}"></td>
      <td><input class="actual" type="number" min="0" step="1" value="${row?.actual||0}"></td>
      <td class="diff">‚Çπ0</td>
      <td><button class="btn-ghost delRow" title="Delete" style="width:auto">‚úï</button></td>
    `;
    tr.querySelector('.type').value = row?.type||'expense';
    // styling pill-like
    const sel=tr.querySelector('.type');
    function paint(){ sel.className = 'type ' + (sel.value==='income'?'type-pill pill-income': sel.value==='saving'?'type-pill pill-saving':'type-pill pill-expense'); }
    sel.addEventListener('change',()=>{paint(); recalc();}); paint();

    tr.addEventListener('input', recalc);
    tr.querySelector('.delRow').addEventListener('click',()=>{ tr.remove(); recalc(); });

    els.tableBody.appendChild(tr);
  }

  function recalc(){
    const rows = Array.from(els.tableBody.querySelectorAll('tr'));
    let income=0, expenses=0, savings=0, plannedIncome=0, plannedExpenses=0, plannedSavings=0;

    const expenseMap = {};

    rows.forEach(tr=>{
      const type = tr.querySelector('.type').value;
      const planned = Number(tr.querySelector('.planned').value)||0;
      const actual = Number(tr.querySelector('.actual').value)||0;
      const diffCell = tr.querySelector('.diff');
      diffCell.textContent = currency(actual - planned);
      diffCell.style.color = (type==='expense' && actual>planned) ? 'var(--danger)' : (type!=='expense' && actual<planned ? 'var(--warning)': 'var(--text)');

      if(type==='income'){ income += actual; plannedIncome += planned; }
      else if(type==='expense'){ expenses += actual; plannedExpenses += planned; expenseMap[tr.querySelector('.cat').value||'Other'] = (expenseMap[tr.querySelector('.cat').value||'Other']||0) + actual; }
      else { savings += actual; plannedSavings += planned; }
    });

    const net = (income - expenses); // savings entries are part of expenses decisioning? keep separate

    els.totalIncome.textContent = currency(income);
    els.totalExpenses.textContent = currency(expenses);
    els.netSavings.textContent = currency(net);

    // Goal logic
    const goalPct = Number(els.goalPercent.value)||0;
    const goalAmt = income * (goalPct/100);
    const actualSaved = net; // treat net as savings potential
    const achievedPct = income>0 ? Math.round((actualSaved/ income)*100) : 0;
    els.goalStatus.textContent = `${achievedPct}% of ${goalPct}%`;
    document.getElementById('kpiSavings').classList.toggle('negative', actualSaved<0);

    // Top 3 expenses
    const top = Object.entries(expenseMap).sort((a,b)=>b[1]-a[1]).slice(0,3);
    els.top3.innerHTML = top.map(([k,v])=>`<div>${k}: <b>${currency(v)}</b></div>`).join('') || '<div>No expenses yet</div>';

    updateChartsAndKpis(income, expenses, net, plannedIncome, plannedExpenses, plannedSavings);
  }

  // Charts
  let pieChart, barChart, lineChart;
  function updateChartsAndKpis(income, expenses, net, pInc=0, pExp=0, pSav=0){
    // Recompute if not provided (when switching tabs)
    if(income===undefined){
      const rows = Array.from(els.tableBody.querySelectorAll('tr'));
      income=0; expenses=0; let plannedIncome=0, plannedExpenses=0, plannedSavings=0;
      const expenseMap = {};
      rows.forEach(tr=>{
        const type = tr.querySelector('.type').value;
        const planned = Number(tr.querySelector('.planned').value)||0;
        const actual = Number(tr.querySelector('.actual').value)||0;
        if(type==='income'){ income += actual; plannedIncome += planned; }
        else if(type==='expense'){ expenses += actual; plannedExpenses += planned; }
        else { plannedSavings += planned; }
      });
      net = income-expenses; pInc=plannedIncome; pExp=plannedExpenses; pSav=plannedSavings;
    }

    // Expense pie
    const expRows = Array.from(els.tableBody.querySelectorAll('tr')).filter(tr=>tr.querySelector('.type').value==='expense');
    const labels = expRows.map(tr=>tr.querySelector('.cat').value||'Other');
    const data = expRows.map(tr=>Number(tr.querySelector('.actual').value)||0);
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(els.expensePie, {
      type:'pie', data:{ labels, datasets:[{ data }] }, options:{ plugins:{ legend:{ position:'bottom' } } }
    });

    // I/E/S bar for dashboard
    if(barChart) barChart.destroy();
    barChart = new Chart(els.iesBar, { type:'bar', data:{ labels:['Income','Expenses','Net'], datasets:[{ data:[income, expenses, net] }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });

    // Dashboard KPIs
    const savingsRate = income>0 ? Math.round((net/income)*100) : 0;
    els.dashSavingsRate.textContent = savingsRate+"%";
    const overspend = Math.max(0, expenses - pExp);
    els.dashOverspend.textContent = currency(overspend);
    els.dashEmergency.textContent = (expenses>0 ? (Math.round(( (load().rows.find(r=>r.name.includes('Emergency'))?.actual||0) / expenses)*10)/10) : 0) + 'x';
    els.dashRecurring.textContent = currency(load().rows.filter(r=>/sip|rd|fd|mutual|investment/i.test(r.name)).reduce((a,b)=>a+(b.actual||0),0));
  }

  // Yearly
  function buildYearly(){
    els.yearlyTableBody.innerHTML='';
    const year = Number(els.yearSelect.value);
    let ti=0, te=0, ts=0; const incomeArr=[], expArr=[], savArr=[];

    for(let m=0;m<12;m++){
      const raw = localStorage.getItem(`pfp:${year}-${String(m+1).padStart(2,'0')}`);
      let income=0, expenses=0;
      if(raw){
        const {rows} = JSON.parse(raw);
        rows.forEach(r=>{ if(r.type==='income') income += Number(r.actual)||0; else if(r.type==='expense') expenses += Number(r.actual)||0; });
      }
      const savings = income-expenses;
      ti+=income; te+=expenses; ts+=savings;
      incomeArr.push(income); expArr.push(expenses); savArr.push(savings);

      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${months[m]}</td><td>${currency(income)}</td><td>${currency(expenses)}</td><td>${currency(savings)}</td>`;
      els.yearlyTableBody.appendChild(tr);
    }

    els.yIncome.textContent = currency(ti);
    els.yExpenses.textContent = currency(te);
    els.ySavings.textContent = currency(ts);

    if(lineChart) lineChart.destroy();
    lineChart = new Chart(els.yearlyLine, { type:'line', data:{ labels:months, datasets:[{label:'Income', data:incomeArr}, {label:'Expenses', data:expArr}, {label:'Savings', data:savArr}] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } } });
  }

  // Exporters
  function exportCSV(){
    const rows = Array.from(els.tableBody.querySelectorAll('tr')).map(tr=>[
      tr.querySelector('.cat').value,
      tr.querySelector('.type').value,
      tr.querySelector('.planned').value,
      tr.querySelector('.actual').value,
      (Number(tr.querySelector('.actual').value||0) - Number(tr.querySelector('.planned').value||0))
    ]);
    const header = ['Category','Type','Planned','Actual','Difference'];
    const lines = [header].concat(rows).map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([lines], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`budget-${key().slice(4)}.csv`; a.click(); URL.revokeObjectURL(url);
  }

  function exportExcel(){
    const data = load();
    const sheet1 = [['Category','Type','Planned','Actual','Difference']];
    data.rows.forEach(r=> sheet1.push([r.name, r.type, r.planned, r.actual, (r.actual - r.planned)]));

    const year = Number(els.yearSelect.value);
    const sheet2 = [['Month','Income','Expenses','Savings']];
    for(let m=0;m<12;m++){
      const raw = localStorage.getItem(`pfp:${year}-${String(m+1).padStart(2,'0')}`);
      let income=0, expenses=0; if(raw){ const {rows}=JSON.parse(raw); rows.forEach(r=>{ if(r.type==='income') income+=Number(r.actual)||0; else if(r.type==='expense') expenses+=Number(r.actual)||0; }); }
      sheet2.push([months[m], income, expenses, income-expenses]);
    }

    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.aoa_to_sheet(sheet1);
    const ws2 = XLSX.utils.aoa_to_sheet(sheet2);
    XLSX.utils.book_append_sheet(wb, ws1, 'Monthly');
    XLSX.utils.book_append_sheet(wb, ws2, 'Yearly');
    XLSX.writeFile(wb, `Personal_Financial_Planner_${key().slice(4)}.xlsx`);
  }

  // Events
  els.addRow.addEventListener('click',()=> addRow({name:'New Category', type:'expense', planned:0, actual:0}));
  els.goalPercent.addEventListener('input', recalc);
  els.saveMonth.addEventListener('click', save);
  els.resetMonth.addEventListener('click',()=>{ localStorage.removeItem(key()); buildTable(); toast('Reset to defaults'); });
  els.monthSelect.addEventListener('change', buildTable);
  els.yearSelect.addEventListener('change', ()=>{ buildTable(); buildYearly(); });
  els.exportCSV.addEventListener('click', exportCSV);
  els.exportExcel.addEventListener('click', exportExcel);

  // First render
  buildTable();
  buildYearly();
})();
</script>
</body>
</html>
